# CAN settings (not needed if cannable is used):
# CAN_BUS_TYPE = 'slcan'  # default: slcan
# CAN_DEVICE = '/dev/ttyACM0'  # Not recommended for slcan - use detection using CAN_AUTODETECT_STRING if possible
# CAN_BITRATE = 500000  # default: 500000
# CAN_AUTODETECT_STRING = 'canable'  # default: canable -- will search for a serial device containing this string

# Axes
NUM_AXES = 6
# AXES_ANGLE_RANGE = [4896, -32200, 22700, 1990.8, 2120, 2120]  # between 0 and this angle in degrees (may be negative)
# AXES_ANGLE_RANGE = [4896, -32200, 22700, 1990.8, 2260.4, 2175.5]  # between 0 and this angle in degrees (may be negative)
AXES_ANGLE_RANGE = [4896, -32200, 22700, 1850, 2260.4, 2175.5]  # between 0 and this angle in degrees (may be negative)

AXIS_INFINITE = [1, 0, 0, 0, 0, 0]  # Which axes can turn further than the range or beyond 0 in the opposite direction  # TODO use in limit checks

# Motor parameters
AXES_WORK_MODE = [5, 5, 5, 5, 5, 5]  # modes 0 through 5: CR_OPEN, CR_CLOSE, CR_vFOC, SR_OPEN, SR_CLOSE, SR_vFOC
AXES_DIRECTION = [0, 0, 0, 0, 0, 0]  # CW(0), CCW(1)
# The "move" command sometimes needs to be inverted, even though move_to works fine
# AXES_RAW_DIRECTION = [0, 0, 0, 0, 1, 1]  # 0: normal, 1: inverted  # TODO still necessary after init?
AXES_CURRENT_LIMIT = [2000, 1600, 1400, 1000, 1000, 1000]  # in mA
# AXES_SPEED_LIMIT = [600, 600, 600, 500, 300, 300, 300]  # in RPM
# AXES_SPEED_LIMIT = [1200, 1200, 1200, 1200, 1000, 500, 500]  # in RPM  # Axes 0 and 3 are too fast
AXES_SPEED_LIMIT = [1000, 1200, 1200, 1000, 1000, 500, 500]  # in RPM
AXES_ACCEL_LIMIT = [200, 200, 200, 200, 200, 200, 200]  # 255-acc = number of 50us ticks between RPM increments by 1
# AXES_ACCEL_LIMIT = [150, 150, 150, 150, 150, 150, 150]
AXES_MOVE_TIMEOUT = [35, 35, 25, 18, 13, 13]  # in seconds

AXES_ANGLE_RATIO = [  # motor degrees per joint degree (or motor turns per joint turn)
    # row: input at motor shaft, column: result at joint
    [13.6,    0,    0,  0   ,  0   ,  0    ],
    [ 0  , -144,    0,  0   ,  0   ,  0    ],
    [ 0  ,    0,  114,119.65,  0   ,  0    ],  # was 22.6 -- also depends on the previous joint's angle
    [ 0  ,    0,    0,  5,     0   ,  0    ],  # was 5.53
    [ 0  ,    0,    0,  0   ,  9.3 ,-11.625],  # was 4.65
    [ 0  ,    0,    0,  0   , -9.3 ,-11.625],  # was 4.65
]
# Arctos designer:
# X    13.6
# Y    144
# Z    114
# A    5.53
# B    4.65
# C    4.65

KINEMATIC_CONVENTION = 'classic'  # 'classic', 'modified' or 'offset'
KINEMATIC_CHAIN = [
    # https://en.wikipedia.org/wiki/Denavit%E2%80%93Hartenberg_parameters
    # alpha,       a,  theta_offset,      d
    #(degrees)   (mm)      (degrees)    (mm)
    # From reconstruction/own drawings of coordinate systems (classic)
    [-90,   20.174,    0,  287.87 ],  # Link 1
    [  0,  260.986,  -90,    0    ],  # Link 2  # changed theta to -90 for a better default pose
    [-90,   19.219,  -90,    0    ],  # Link 3
    [ 90,    0    ,  180,  260.753],  # Link 4  # changed theta to 180 for a zero pos that is not at the end of the joint range
    [-90,    0    ,    0,    0    ],  # Link 5
    [  0,    0    ,    0,   74.745],  # Fixed link

    # original from the thesis (modified DH parameter convention)
    #     [      0,      0,             0, 287.87],  # Link 1
    #     [    -90, 20.174,           -90,      0],  # Link 2
    #     [      0,260.986,             0,      0],  # Link 3
    #     [      0, 19.219,             0,260.753],  # Link 4
    #     [     90,      0,             0,      0],  # Link 5
    #     [    -90,      0,           180, 74.745],  # Link 6
]
FIXED_LINKS = []  # Indices of links that will be hidden and do not change with theta (just for fixed transformations, e.g. extending the end effector position)
JOINT_BOUND = [(-45, 45), (-45, 45), (-45, 45), (-45, 45), (-45, 45), (-45, 45)]  # in joint degrees
# JOINT_ZERO_OFFSET = [0, -82.2, -35.1, -35.1, 0, 0]  # in joint degrees (note that joint at idx 3's offset also depends on the previous joint's angle)
# JOINT_ZERO_OFFSET = [0, -82.2, -35.1, -90, 0, 0]  # in joint degrees (note that joint at idx 3's offset also depends on the previous joint's angle)
JOINT_ZERO_OFFSET = [0, -82.2, -35.1, -(180+33.4), 0, 0]  # in joint degrees (note that joint at idx 3's offset also depends on the previous joint's angle)
# Vertical pose (ca.)
# 6: can_id: None, state: stopped (1) , angle: 1059.9, timestamp: 20:55:35.407, shaft_lock: False
# 5: can_id: None, state: stopped (1) , angle: 1119.7, timestamp: 20:55:35.368, shaft_lock: False
# 4: can_id: None, state: stopped (1) , angle: 1441.0, timestamp: 20:55:35.329, shaft_lock: False
# 3: can_id: None, state: stopped (1) , angle: 5056.8, timestamp: 20:55:35.293, shaft_lock: False
# 2: can_id: None, state: stopped (1) , angle: -12273.7, timestamp: 20:55:35.257, shaft_lock: False
# 1: can_id: None, state: stopped (1) , angle:    0.0, timestamp: 20:55:35.221, shaft_lock: False

# Homing
# # We support a mixture of native endstop homing (value -1), sensorless homing (0, 1) or deactivated homing (None)
# ENDSTOP = -1; CW = 1; CCW = 0; NONE = None
# AXES_HOMING_DIRECTION = [ENDSTOP, CW, CCW, ENDSTOP, CW, CW]
# We support a mixture of native endstop homing, sensorless homing or deactivated homing (None)
SENSORLESS = 0; ENDSTOP = 1; CW = 0; CCW = 1; NONE = None; LOW = 0; HIGH = 1
AXES_HOMING_MODE = [ENDSTOP, SENSORLESS, SENSORLESS, ENDSTOP, SENSORLESS, SENSORLESS]
AXES_ENDSTOP_TRIGGER = [LOW, None, None, LOW, None, None]
AXES_HOMING_DIRECTION = [CCW, CCW, CW, CCW, CCW, CCW]
AXES_HOMING_SPEED = [90, 200, 300, 50, 30, 30]  # in RPM
AXES_HOMING_CURRENT_LIMIT = [450, 450, 450, 450, 450, 500]  # in mA
AXES_SAFE_HOMING_ANGLE = [AXES_ANGLE_RANGE[i] * factor for i, factor in enumerate([0, 0.25, 0.75, 0.5, 0.5, 0.5])]
# order in which to home the axes (homing 3 twice to prevent collisions at first and to make it look neat in the end)
HOMING_ORDER = [5, 4, 3, 2, 1, 0, 3]
MOVE_ZERO_AFTER_HOME = False # move to zero position after homing

# Others
# Move arm left-right
# ARM_DEMO_SEQUENCE = [
#     [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
#      [-0.00807818244485294, -24.499957275390628, 99.2211605674342, 0.05200560554220601, 0.0, -23.577368951612904],
#      [-120.62665153952206, -10.397326660156253, 123.69927785773027, 90.00412302810284, 0.0, -23.579259072580648],
#      [-0.00807818244485294, -24.499957275390628, 99.2211605674342, 0.05200560554220601, 0.0, -23.577368951612904],
#      # [120.62665153952206, -10.397326660156253, 123.69927785773027, -90.00412302810284, 0.0, -23.579259072580648],
#      # [-0.00807818244485294, -24.499957275390628, 99.2211605674342, 0.05200560554220601, 0.0, -23.577368951612904],
#      # [-120.62665153952206, -10.397326660156253, 123.69927785773027, 90.00412302810284, 0.0, -23.579259072580648],
#      # [-0.00807818244485294, -24.499957275390628, 99.2211605674342, 0.05200560554220601, 0.0, -23.577368951612904],
#      # [120.62665153952206, -10.397326660156253, 123.69927785773027, -90.00412302810284, 0.0, -23.579259072580648],
#      [-0.00807818244485294, -24.499957275390628, 99.2211605674342, 0.05200560554220601, 0.0, -23.577368951612904],
#      [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
#  ]

# Pick up item with hook
ARM_DEMO_SEQUENCE = [
    [0.0, 70.1382568359375, 134.6181460731908, 133.24772272807408, 4.552828881048384, -190.76423891129033],
    [0.0, 70.51255493164062, 106.88788291529605, 121.3024979677053, 4.548103578629039, -190.76423891129033],
    [-42.72550695082721, 39.89991455078125, 96.18411543996712, 111.1041737538524, 4.550466229838705, -190.76612903225808],
    [47.81960880055147, 31.764538574218747, 122.4876978824013, 120.7496574889652, 4.550466229838705, -190.76612903225808],
    [34.505148494944855, 67.42936401367187, 108.14495014391449, 113.48262702250051, 4.552828881048384, -190.76423891129033],
    [34.505148494944855, 65.38895874023437, 131.82010176809212, 124.35914879498799, 4.552828881048384, -190.76423891129033],
    [34.505148494944855, 26.715863037109372, 131.82010176809212, 124.35914879498799, 4.552828881048384, -190.76423891129033],
    [1.4960793887867647, -2.386614990234378, 118.37649825246712, 125.57331572555367, 4.548103578629039, -190.76423891129033]
]

# Push item from slot 3 to slot 4
ARM_DEMO_SEQUENCE = [
        [2.155259076286765, -26.295153808593753, 114.24756630345394, 114.00166101324177, 4.562279485887089, -190.78314012096774],  # start pos
        # [-0.30858656939338236, 43.38929443359375, 141.3404296875, 139.7931979748877, 4.562279485887089, -190.78314012096774],  # hover in front of row
    [-0.5202349494485294, 34.8208740234375, 151.53169459292764, 131.7888650654252, 5.488438760080641, -190.70753528225808],  # hover in front of row
    [-0.5202349494485294, 66.93253784179687, 146.64952456825657, 132.74465816639676, 16.98273689516128, -190.1499495967742],  # before pushing slot 3
        # [-0.310202205882353, 69.22501831054687, 144.6509765625, 129.91323762503916, 18.123897429435488, -190.59034778225808],  # before pushing slot 3
        [-2.4945427389705883, 70.16785888671875, 104.71740851151316, 110.21254301282383, -3.560515372983872, -185.4983618951613],  # after pushing slot 3
        [-8.856919232536764, 70.84901123046875, 96.59619911595394, 94.92502105751149, -11.572265624999972, -270.226814516129],  # turned towards 4
        [15.230605181525736, 69.16337280273437, 104.03163034539475, 108.43854255086453, -13.386781754032256, -366.07106854838713],  # moved into 4
        [0.8740593405330883, 51.99891357421875, 83.71309107730264, 110.24792330495197, -13.386781754032256, -366.0748487903226]  # clear behind row
]

ARM_DEMO_SEQUENCE = [
# start pos:
[2.155259076286765, -26.295153808593753, 114.24756630345394, 114.00166101324177, 4.562279485887089, -190.78314012096774],
# hover in front of row:
[-0.5202349494485294, 34.8208740234375, 151.53169459292764, 131.7888650654252, 5.488438760080641, -190.70753528225808],

# before pushing 1:
[-42.964621151194855, 64.0052734375, 126.219580078125, 107.37758187127824, 2.719411542338719, -223.72038810483872],
# after pushing 1:
[-31.237189797794116, 72.62537841796875, 94.5826171875, 121.5709757299937, -4.231508316532256, -212.48928931451616],
# 1 turn left:
[-31.74564137178309, 73.77518920898437, 83.40778680098683, 112.05322722687262, -20.822045110887075, -301.44594254032256],
# 3 turn left:
[-8.856919232536764, 70.84901123046875, 96.59619911595394, 94.92502105751149, -11.572265624999972, -270.226814516129],
# move into 4:
[15.230605181525736, 69.16337280273437, 104.03163034539475, 108.43854255086453, -13.386781754032256, -366.07106854838713],

# clear behind row:
[0.8740593405330883, 43.99891357421875, 83.71309107730264, 110.24792330495197, -13.386781754032256, -366.0748487903226],


# hover in front of row:
[-0.5202349494485294, 34.8208740234375, 151.53169459292764, 131.7888650654252, 5.488438760080641, -190.70753528225808],

# before pushing 3:
[-0.5202349494485294, 65.53253784179687, 146.64952456825657, 132.74465816639676, 16.98273689516128, -190.1499495967742],
# after pushing 3:
[-2.4945427389705883, 68.56785888671875, 104.71740851151316, 110.21254301282383, -3.560515372983872, -185.4983618951613],
# 3 turn right:
[2.5882496553308822, 72.80289916992187, 89.6229646381579, 114.21319901960143, -14.506678427419352, -95.21295362903226],
# # 2 turn right:
# [-8.900541417738971, 72.80289916992187, 89.6229646381579, 114.21319901960143, -15.555695564516121, -106.0093245967742],
# move into 1:
[-30.642161649816178, 70.02671508789062, 100.36913548519738, 123.57301802294452, 3.1021610383064484, -50.83858366935485],

# clear behind row:
[0.8740593405330883, 43.99891357421875, 83.71309107730264, 110.24792330495197, -13.386781754032256, -366.0748487903226],

# hover in front of row:
[-0.5202349494485294, 34.8208740234375, 151.53169459292764, 131.7888650654252, 5.488438760080641, -190.70753528225808],

# before pushing 4:
[24.10691205193015, 65.67689208984375, 142.40533254523027, 155.75361577060696, 15.210748487903231, -195.03780241935488],
# after pushing 4:
[10.832842658547795, 69.38172607421875, 103.12265625, 119.78049898956593, -0.22917716733871885, -181.46484375],
# 4 turn right:
[18.50388470818015, 74.0786865234375, 85.13977179276316, 109.85381667395788, -18.128622731854833, -79.4436743951613],
# move into 3 from left:
[-2.4557674632352944, 68.13721923828125, 109.20021587171053, 117.77077682629019, 5.408108618951612, -17.95047883064516],

# clear behind row:
[0.8740593405330883, 43.99891357421875, 83.71309107730264, 110.24792330495197, -13.386781754032256, -366.0748487903226],


]

# VOCABULARY:
# start pos:
[2.155259076286765, -26.295153808593753, 114.24756630345394, 114.00166101324177, 4.562279485887089, -190.78314012096774],
# hover in front of row:
[-0.5202349494485294, 34.8208740234375, 151.53169459292764, 131.7888650654252, 5.488438760080641, -190.70753528225808],

# before pushing 4:
[24.10691205193015, 65.67689208984375, 142.40533254523027, 155.75361577060696, 15.210748487903231, -195.03780241935488],
# after pushing 4:
[10.832842658547795, 69.38172607421875, 103.12265625, 119.78049898956593, -0.22917716733871885, -181.46484375],
# 4 turn right:
[18.50388470818015, 74.0786865234375, 85.13977179276316, 109.85381667395788, -18.128622731854833, -79.4436743951613],
# move into 4:
[15.230605181525736, 69.16337280273437, 104.03163034539475, 108.43854255086453, -13.386781754032256, -366.07106854838713],

# before pushing 3:
[-0.5202349494485294, 65.53253784179687, 146.64952456825657, 132.74465816639676, 16.98273689516128, -190.1499495967742],
# after pushing 3:
[-2.4945427389705883, 68.56785888671875, 104.71740851151316, 110.21254301282383, -3.560515372983872, -185.4983618951613],
# 3 turn left:
[-8.856919232536764, 70.84901123046875, 96.59619911595394, 94.92502105751149, -11.572265624999972, -270.226814516129],
# 3 turn right:
[2.5882496553308822, 72.80289916992187, 89.6229646381579, 114.21319901960143, -14.506678427419352, -95.21295362903226],
# move into 3 from left:
[-2.4557674632352944, 68.13721923828125, 109.20021587171053, 117.77077682629019, 5.408108618951612, -17.95047883064516],
# [-3.5414751838235294, 68.10258178710937, 107.44895662006579, 123.87613967659578, 16.160534274193544, -9.114163306451612],  # possibly from right?

# before pushing 2:
[-24.098833869485293, 65.15382080078125, 145.25541735197368, 125.51452670386286, 14.50431577620968, -205.3975554435484],
# after pushing 2:
[-16.469798368566178, 69.38172607421875, 101.21739566200657, 127.38708182883667, -3.732988911290306, -212.0866935483871],
# 2 turn left:
[-20.71084415211397, 72.26670532226562, 88.57849249588816, 101.76589952302285, -18.01285282258064, -288.1224798387097],
# 2 turn right:
[-8.900541417738971, 72.80289916992187, 89.6229646381579, 114.21319901960143, -15.555695564516121, -106.0093245967742],
# move into 2 from left:
[-17.969109030330884, 68.89298706054687, 107.67041786595394, 130.4855807873877, 15.966796874999998, -31.5952620967742],

# before pushing 1:
[-42.964621151194855, 64.0052734375, 126.219580078125, 107.37758187127824, 2.719411542338719, -223.72038810483872],
# after pushing 1:
[-31.237189797794116, 72.62537841796875, 94.5826171875, 121.5709757299937, -4.231508316532256, -212.48928931451616],
# 1 turn left:
[-31.74564137178309, 73.77518920898437, 83.40778680098683, 112.05322722687262, -20.822045110887075, -301.44594254032256],
# move into 1:
[-30.642161649816178, 70.02671508789062, 100.36913548519738, 123.57301802294452, 3.1021610383064484, -50.83858366935485],

# clear behind row:
[0.8740593405330883, 43.99891357421875, 83.71309107730264, 110.24792330495197, -13.386781754032256, -366.0748487903226],

# ARM_DEMO_SEQUENCE = [
#     [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
#     [0.0, -35.83525390625, 109.37696083470394, 0.0602694545288216, -0.004725302419354838, 0.0],
#     [36.95768468520221, -2.884814453125003, 35.75584138569078, -0.035554465498336185, -0.007087953629032257, -0.0018901209677419355], [36.95768468520221, -2.884814453125003, 35.755648643092094, -0.03134357533693333, 83.47719254032256, -66.78553427419355], [36.95606904871324, -2.884814453125003, 35.755648643092094, -0.03134357533693333, -94.3973664314516, 75.51411290322581], [36.95768468520221, -2.884814453125003, 35.75584138569078, -0.031159934248336185, -0.021263860887096975, 8.050025201612904],
#     [0.0, -35.83525390625, 109.37696083470394, 0.0602694545288216, -0.004725302419354838, 0.0],
#     [-36.95768468520221, -2.884814453125003, 35.75584138569078, -0.035554465498336185, -0.007087953629032257, -0.0018901209677419355], [-36.95768468520221, -2.884814453125003, 35.755648643092094, -0.03134357533693333, 83.47719254032256, -66.78553427419355], [-36.95606904871324, -2.884814453125003, 35.755648643092094, -0.03134357533693333, -94.3973664314516, 75.51411290322581], [-36.95768468520221, -2.884814453125003, 35.75584138569078, -0.031159934248336185, -0.021263860887096975, 8.050025201612904],
#     [0.0, -35.83525390625, 109.37696083470394, 0.0602694545288216, -0.004725302419354838, 0.0],
#     [36.95768468520221, -2.884814453125003, 35.75584138569078, -0.035554465498336185, -0.007087953629032257, -0.0018901209677419355], [36.95768468520221, -2.884814453125003, 35.755648643092094, -0.03134357533693333, 83.47719254032256, -66.78553427419355], [36.95606904871324, -2.884814453125003, 35.755648643092094, -0.03134357533693333, -94.3973664314516, 75.51411290322581], [36.95768468520221, -2.884814453125003, 35.75584138569078, -0.031159934248336185, -0.021263860887096975, 8.050025201612904],
#     [0.0, -35.83525390625, 109.37696083470394, 0.0602694545288216, -0.004725302419354838, 0.0],
#     [-36.95768468520221, -2.884814453125003, 35.75584138569078, -0.035554465498336185, -0.007087953629032257, -0.0018901209677419355], [-36.95768468520221, -2.884814453125003, 35.755648643092094, -0.03134357533693333, 83.47719254032256, -66.78553427419355], [-36.95606904871324, -2.884814453125003, 35.755648643092094, -0.03134357533693333, -94.3973664314516, 75.51411290322581], [-36.95768468520221, -2.884814453125003, 35.75584138569078, -0.031159934248336185, -0.021263860887096975, 8.050025201612904],
#     [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
# ]
# ARM_DEMO_SEQUENCE = [[81.67527142693015, 28.506329345703122, -4.428292043585529, -5.226935617882901, 31.205897177419352, -24.953377016129036], [81.70758415670956, -20.0, 50.069677734375, -0.23161703732242245, -6.766633064516128, 5.424647177419356], [81.70758415670956, -20.0, 50.069677734375, -0.23601156857242245, -13.873487903225808, 166.06224798387098], [81.70919979319854, -20.0, 50.069677734375, -0.23601156857242245, 0.5197832661290533, 355.1008064516129]]
# ARM_DEMO_SEQUENCE =  [[0, 0, 0, 0, 0, 0], [-79.67996036305148, -38.221728515625, 120.0001619037829, 94.0910113808504, 45.048670614919345, 21.26953125], [-79.68157599954044, -38.22188110351563, 120.0001619037829, 94.0910113808504, 45.00378024193548, 90.01134072580646], [-79.68157599954044, -38.221728515625, 120.0001619037829, 94.0910113808504, 45.00378024193547, -89.9773185483871], [0, 0, 0, 0, 0, 0]]
# ARM_DEMO_SEQUENCE = [[0.0, -5733.17138671875, 20418.1787109375, 800.244140625, 1059.71923828125, 78.99169921875], [-1793.60595703125, -10919.2236328125, 6865.927734375, 1360.458984375, -619.541015625, -812.2412109375], [-1793.6279296875, -10919.24560546875, 6865.90576171875, 1360.458984375, -1459.51171875, -1727.666015625]]
# [[0.0, -8050.60546875, 17025.7763671875, 678.8671875, 1838.03466796875, 1059.873046875], [-1996.28173828125, -8086.46484375, 13008.955078125, 893.51806640625, 642.48046875, 110.98388671875]]
# [[-8.0419921875, -5762.63671875, 17774.97802734375, 910, 447.42919921875, 1060.13671875], [-1570.62744140625, -11576.75537109375, 10465.0927734375, 255.34423828125, 1561.13525390625, 2055.498046875]]